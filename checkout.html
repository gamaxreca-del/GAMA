<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIMHACK â€” Checkout</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    .coupon-box { border: 2px solid #ff0000; border-radius: 10px; padding: 11px 12px 14px 12px; margin: 12px 0 15px 0; background: none; box-shadow: none; display:flex; flex-direction:column; align-items:stretch;}
    .coupon-header { display:flex; align-items:center; gap:8px; margin-bottom:7px; color:#ff2626; font-weight:900; font-size:16px; letter-spacing:0.3px;}
    .coupon-input-row { display:flex; gap:7px; }
    .coupon-input-row input { flex:1; padding:9px 11px; border-radius:7px; border:1px solid #ff0000; background:#1a181b; color:#fff; font-size:14px; }
    .apply-btn { padding:9px 15px; background:#d60000; border:none; border-radius:7px; color:#fff; font-weight:900; cursor:pointer; font-size:14px; transition:background .2s; }
    .apply-btn:hover { background:#ff2626; }
    .coupon-msg { padding:6px 10px; border-radius:6px; font-size:12px; font-weight:700; text-align:center; margin-top:7px; }
    .coupon-success { background:#102b15; border:1px solid #19bf00; color:#19bf00; }
    .coupon-error { background:#2d1919; border:1px solid #ff2222; color:#ff2222; }

    :root{ --bg:#000000; --panel:#0f0f10; --card:#0f0f12; --accent:#c70000c4; --accent-2:#c70000c4; --muted:#9a9a9a; }
    body{margin:0;background:var(--bg);color:#fff;font-family:"Segoe UI",sans-serif;direction:rtl}
    .header,footer{background:var(--panel);padding:16px 28px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #151515}
    .logo{color:var(--accent);font-weight:800;font-size:22px}
    footer{border-top:1px solid rgba(255,255,255,0.05);justify-content:center;color:var(--muted);margin-top:40px}

    .container{display:flex;gap:20px;max-width:1200px;margin:90px auto 40px;padding:0 20px}
    .products{flex:2;background:var(--card);border-radius:12px;padding:20px}
    .summary{flex:1;background:var(--card);border-radius:12px;padding:20px;height:fit-content}

    .prod{display:flex;align-items:center;gap:14px;padding:12px;border-bottom:1px solid rgba(255,255,255,0.05)}
    .prod img{width:70px;height:60px;object-fit:cover;border-radius:8px}
    .prod-info{flex:1}
    .prod-info h4{margin:0;font-size:15px;font-weight:700}
    .prod-info p{margin:6px 0 0;font-size:13px;color:var(--muted)}
    .prod-total{font-weight:800;color:#fff}

    .total{font-size:18px;font-weight:800;margin:16px 0;color:var(--accent)}
    .method{display:flex;align-items:center;gap:10px;background:#101012;padding:10px;border-radius:10px;margin-bottom:12px;cursor:pointer}
    .method input{margin-left:6px;transform:scale(1.2)}
    .method img{width:36px;height:36px;border-radius:6px;object-fit:cover}
    .btn-check{width:100%;padding:14px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:800;cursor:pointer}
    .btn-check:hover{background:var(--accent-2)}

    @media(max-width:800px){ .container{flex-direction:column} }

    .debug-btn {
      background: #666;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 12px;
      cursor: pointer;
      width: 100%;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="logo">AIMHACK</div>
    <div style="color:var(--muted);font-size:14px">Ø§Ù„Ø¯ÙØ¹</div>
  </div>

  <div class="container">
    <div class="products">
      <h2>ğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
      <div id="cartItems" aria-live="polite"></div>
    </div>

    <div class="summary">
      <div class="side">
        <div class="box">
          <h3>âš¡ Ø®Ø¯Ù…Ø© ÙÙˆØ±ÙŠØ©</h3>
          Ø§Ø³ØªÙ„Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹.
        </div>
        <div class="box" style="margin-top:12px;">
          <h3>ğŸ”’ Ø£Ù…Ø§Ù† ÙƒØ§Ù…Ù„</h3>
          Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø­Ù…ÙŠØ© ÙˆÙ…Ø´ÙØ±Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡
        </div>

        <h3 style="margin-top:14px">ğŸ’³ Ø§Ù„Ø¯ÙØ¹</h3>
        <div class="total" id="totalPrice">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: 0.00 EGP</div>

        <label class="method" id="methodVodafone">
          <input type="radio" name="payment" value="Vodafone Cash">
          <img src="PNG/v11.png" alt="vodafone">
          <span>ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</span>
        </label>

        <label class="method" id="methodGems">
          <input type="radio" name="payment" value="Ø¬ÙˆØ§Ù‡Ø± Free Fire">
          <img src="PNG/v12.png" alt="gems">
          <span>Ø¬ÙˆØ§Ù‡Ø± / ID</span>
        </label>

        <label class="method" id="methodBinance">
          <input type="radio" name="payment" value="Binance">
          <img src="PNG/v13.jpg" alt="binance">
          <span>Binance</span>
        </label>

        <div class="coupon-box" aria-hidden="false">
          <div class="coupon-header">
            <i class="fa fa-tag"></i>
            <span>Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…</span>
          </div>
          <div class="coupon-input-row">
            <input type="text" id="couponCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…..." autocomplete="off">
            <button class="apply-btn" id="applyCouponBtn" type="button">ØªØ·Ø¨ÙŠÙ‚</button>
          </div>
          <div id="couponMsg" class="coupon-msg" role="status" aria-live="polite"></div>
          
          </button>
        </div>

        <button class="btn-check" id="confirmBtn">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ âœ…</button>
      </div>
    </div>
  </div>

  <footer>Â© 2025 AIMHACK â€” Ù„Ù„ØªÙˆØ§ØµÙ„: 01064061942</footer>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
  // =============================================
// ğŸ”¥ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù… - Ø¥ØºÙ„Ø§Ù‚ ÙÙˆØ±ÙŠ ØµØ§Ù…Øª
// =============================================
class AdvancedProtectionSystem {
    constructor() {
        this.attempts = 0;
        this.maxAttempts = 1;
        this.userIP = null;
        this.init();
    }

    async init() {
        console.log('ğŸ›¡ï¸ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…');
        await this.getUserIP();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø­Ø¸ÙˆØ±Ø§Ù‹ Ù…Ø³Ø¨Ù‚Ø§Ù‹
        if (this.isPreviouslyBlocked()) {
            this.silentShutdown();
            return;
        }
        
        this.startAdvancedProtection();
    }

    async getUserIP() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            this.userIP = data.ip;
        } catch (error) {
            this.userIP = 'unknown-' + Math.random().toString(36).substr(2, 9);
        }
    }

    isPreviouslyBlocked() {
        return localStorage.getItem('aimhack_blocked') === 'true';
    }

    markAsBlocked() {
        localStorage.setItem('aimhack_blocked', 'true');
        localStorage.setItem('aimhack_blocked_ip', this.userIP);
        localStorage.setItem('aimhack_blocked_time', new Date().toISOString());
    }

    detectAttack(source = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ') {
        console.log('ğŸš¨ Ø§ÙƒØªØ´Ø§Ù Ù‡Ø¬ÙˆÙ…:', source);
        
        this.attempts++;
        
        if (this.attempts >= this.maxAttempts) {
            this.silentShutdown();
        }
    }

    silentShutdown() {
        console.log('ğŸ’€ Ø¥ØºÙ„Ø§Ù‚ ØµØ§Ù…Øª Ù„Ù„Ù…ÙˆÙ‚Ø¹');
        
        // ØªØ³Ø¬ÙŠÙ„ ÙÙŠ localStorage
        this.markAsBlocked();
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙˆØ±Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø±Ø³Ø§Ø¦Ù„
        this.completeSilentShutdown();
    }

    completeSilentShutdown() {
        // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„ØµÙØ­Ø© ÙÙˆØ±Ø§Ù‹
        document.body.innerHTML = '';
        
        // Ø¬Ø¹Ù„ Ø§Ù„ØµÙØ­Ø© ÙØ§Ø±ØºØ© ØªÙ…Ø§Ù…Ø§Ù‹
        document.body.style.cssText = `
            background: #000 !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
        `;
        
        // Ù…Ù†Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙÙˆØ±Ø§Ù‹
        this.preventAllEvents();
        
        // Ù…Ù†Ø¹ Ø£ÙŠ Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
        window.onbeforeunload = null;
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ ÙÙˆØ±ÙŠ Ø¥Ù„Ù‰ ØµÙØ­Ø© ÙØ§Ø±ØºØ©
        setTimeout(() => {
            window.location.replace('about:blank');
        }, 100);
        
        // Ù…Ù†Ø¹ ÙØªØ­ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±
        setInterval(function() {
            debugger;
        }, 50);
    }

    preventAllEvents() {
        const preventEverything = (e) => {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            return false;
        };

        const events = [
            'click', 'dblclick', 'mousedown', 'mouseup', 'mousemove',
            'keydown', 'keyup', 'keypress',
            'touchstart', 'touchend', 'touchmove',
            'scroll', 'wheel', 'contextmenu',
            'dragstart', 'drag', 'dragend', 'drop'
        ];

        events.forEach(event => {
            document.addEventListener(event, preventEverything, true);
            window.addEventListener(event, preventEverything, true);
        });

        // Ù…Ù†Ø¹ Ø¬Ù…ÙŠØ¹ Ø£Ø­Ø¯Ø§Ø« Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        document.onkeydown = document.onkeyup = document.onkeypress = function(e) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        };
    }

    startAdvancedProtection() {
        console.log('ğŸ”’ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙÙˆØ±ÙŠØ©');
        
        // 1. ÙƒØ´Ù ÙØªØ­ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±
        this.detectDevTools();
        
        // 2. Ù…Ù†Ø¹ ÙØ­Øµ Ø§Ù„Ù…ØµØ¯Ø±
        this.preventSourceInspection();
        
        // 3. Ù…Ù†Ø¹ Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        this.preventKeyboardShortcuts();
        
        // 4. ÙƒØ´Ù ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
        this.detectWindowResize();
    }

    detectDevTools() {
        // ÙƒØ´Ù Ù…Ù† Ø®Ù„Ø§Ù„ Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø©
        const checkDevTools = () => {
            if (window.outerWidth - window.innerWidth > 100 || 
                window.outerHeight - window.innerHeight > 100) {
                this.detectAttack('ÙØªØ­ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±');
            }
        };
        setInterval(checkDevTools, 500);

        // ÙƒØ´Ù Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„ÙˆÙ‚Øª
        let lastTime = Date.now();
        setInterval(() => {
            const currentTime = Date.now();
            if (currentTime - lastTime > 100) {
                this.detectAttack('Ø§Ø³ØªØ®Ø¯Ø§Ù… Debugger');
            }
            lastTime = currentTime;
        }, 50);

        // ÙƒØ´Ù Ù…Ù† Ø®Ù„Ø§Ù„ console
        const element = new Image();
        Object.defineProperty(element, 'id', {
            get: () => {
                this.detectAttack('ÙØ­Øµ Ø§Ù„Ø¹Ù†Ø§ØµØ±');
            }
        });
    }

    preventSourceInspection() {
        // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ø£ÙŠÙ…Ù†
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            this.detectAttack('Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ø£ÙŠÙ…Ù†');
        });

        // Ù…Ù†Ø¹ Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª
        document.addEventListener('dragstart', (e) => {
            e.preventDefault();
            this.detectAttack('Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª');
        });

        // Ù…Ù†Ø¹ Ø§Ù„Ù†Ø³Ø®
        document.addEventListener('copy', (e) => {
            e.preventDefault();
            this.detectAttack('Ù†Ø³Ø® Ø§Ù„Ù…Ø­ØªÙˆÙ‰');
        });

        // Ù…Ù†Ø¹ Ø§Ù„Ù‚Øµ
        document.addEventListener('cut', (e) => {
            e.preventDefault();
            this.detectAttack('Ù‚Øµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰');
        });
    }

    preventKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            const blockedCombinations = [
                e.key === 'F12',
                e.ctrlKey && e.shiftKey && e.key === 'I',
                e.ctrlKey && e.shiftKey && e.key === 'J',
                e.ctrlKey && e.shiftKey && e.key === 'C',
                e.ctrlKey && e.key === 'U',
                e.ctrlKey && e.key === 'S'
            ];

            if (blockedCombinations.some(combination => combination)) {
                e.preventDefault();
                this.detectAttack(`Ø§Ø®ØªØµØ§Ø±: ${e.key}`);
            }
        }, true);
    }

    detectWindowResize() {
        let lastWidth = window.innerWidth;
        let lastHeight = window.innerHeight;
        
        setInterval(() => {
            const widthDiff = Math.abs(window.innerWidth - lastWidth);
            const heightDiff = Math.abs(window.innerHeight - lastHeight);
            
            if (widthDiff > 50 || heightDiff > 50) {
                this.detectAttack('ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©');
            }
            
            lastWidth = window.innerWidth;
            lastHeight = window.innerHeight;
        }, 300);
    }
}

// ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙÙˆØ± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙÙˆØ±ÙŠ...');
    
    // ØªÙ‡ÙŠØ¦Ø© Firebase Ø£ÙˆÙ„Ø§Ù‹
    if (typeof firebase !== 'undefined') {
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
        } catch (error) {
            // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        }
    }
    
    // Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙÙˆØ±Ø§Ù‹
    window.protectionSystem = new AdvancedProtectionSystem();
});
const firebaseConfig = {
    apiKey: "AIzaSyAd5KNh5H6KaQ9nv8FP3keyFRh28zSwfLM",
    authDomain: "gama-xiter.firebaseapp.com",
    projectId: "gama-xiter",
    storageBucket: "gama-xiter.firebasestorage.app",
    messagingSenderId: "979348178199",
    appId: "1:979348178199:web:dd66b3d0d00b76fe61a352",
    measurementId: "G-4Q4P3GTJN5"
};

let db;
try {
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    } else {
        firebase.app();
    }
    db = firebase.firestore();
    console.log('âœ… Firebase initialized successfully');
} catch (error) {
    console.error('âŒ Firebase initialization error:', error);
}

const params = new URLSearchParams(window.location.search);
const rawCart = params.get("cart");
let cart = [];

try {
  if(rawCart){
    const decoded = decodeURIComponent(rawCart);
    const parsed = JSON.parse(decoded);
    if(Array.isArray(parsed)){
      parsed.forEach(it=>{
        const id = Number(it.id) || 0;
        const qty = Math.max(1, parseInt(it.qty || it.quantity || 1, 10) || 1);
        const price = Number(it.price) || 0;
        const title = String(it.title || '').trim();
        const img = it.img || 'PNG/placeholder.jpg';
        if(id && title && price >= 0 && qty > 0){
          cart.push({ id, title, price, qty, img });
        }
      });
    }
  }
} catch(e){
  console.error('Cart parsing error:', e);
}

const cartItems = document.getElementById("cartItems");
const totalPrice = document.getElementById("totalPrice");
let originalTotal = 0.0;
let currentTotal = 0.0;
let appliedCouponKey = null;
let appliedCouponData = null;

function renderCart(){
  cartItems.innerHTML = '';
  originalTotal = 0;
  if(!Array.isArray(cart) || cart.length === 0){
    const p = document.createElement('div'); p.className='prod'; p.innerHTML = '<div style="color:var(--muted);padding:12px">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>';
    cartItems.appendChild(p);
    totalPrice.textContent = 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: 0.00 EGP';
    return;
  }
  cart.forEach(item=>{
    const div = document.createElement('div');
    div.className = 'prod';
    const img = document.createElement('img'); img.src = item.img; img.alt = item.title || 'product';
    const info = document.createElement('div'); info.className='prod-info';
    const h4 = document.createElement('h4'); h4.textContent = item.title;
    const p = document.createElement('p'); p.textContent = item.price + ' Ã— ' + item.qty;
    info.appendChild(h4); info.appendChild(p);
    const tot = document.createElement('div'); tot.className='prod-total'; tot.textContent = (Number(item.price) * Number(item.qty)).toFixed(2) + ' EGP';
    div.appendChild(img); div.appendChild(info); div.appendChild(tot);
    cartItems.appendChild(div);
    originalTotal += Number(item.price) * Number(item.qty);
  });
  currentTotal = originalTotal;
  totalPrice.textContent = 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ' + originalTotal.toFixed(2) + ' EGP';
}
renderCart();

async function applyCouponCode(code) {
    const key = String(code || '').trim().toUpperCase();
    console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†:', key);
    
    if(!key) return { ok:false, msg:'Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯' };
    
    try {
        if (!db) {
            console.error('âŒ Firebase ØºÙŠØ± Ù…ØªØµÙ„');
            return { ok:false, msg:'Ù†Ø¸Ø§Ù… Ø§Ù„Ø®ØµÙ… ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹' };
        }

        const querySnapshot = await db.collection('coupons').where('code', '==', key).get();
        
        console.log('ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«:', querySnapshot.size, 'ÙƒÙˆØ¨ÙˆÙ† ÙˆØ¬Ø¯');
        
        if (querySnapshot.empty) {
            return { ok: false, msg: 'ÙƒÙˆØ¯ Ø®ØµÙ… ØºÙŠØ± ØµØ­ÙŠØ­' };
        }
        
        const couponDoc = querySnapshot.docs[0];
        const coupon = couponDoc.data();
        console.log('âœ… Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯:', coupon);
        
        const now = new Date();
        
        if (coupon.isActive === false) {
            return { ok:false, msg:'Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† ØºÙŠØ± Ù†Ø´Ø·' };
        }
        
        if (coupon.startDate) {
            const startDate = new Date(coupon.startDate);
            if (startDate > now) {
                return { ok:false, msg:'Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯' };
            }
        }
        
        if (coupon.endDate) {
            const endDate = new Date(coupon.endDate);
            if (endDate < now) {
                return { ok:false, msg:'Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©' };
            }
        }
        
        if (coupon.usageLimit && (coupon.usedCount || 0) >= coupon.usageLimit) {
            return { ok:false, msg:'ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ù„Ø£Ù‚ØµÙ‰ Ø­Ø¯' };
        }
        
        let discountAmount = 0;
        let newTotal = originalTotal;
        
        if (coupon.discountType === 'percent') {
            const perc = Math.min(100, Number(coupon.discountValue) || 0);
            discountAmount = Math.round(originalTotal * perc / 100);
            newTotal = Math.max(0, originalTotal - discountAmount);
        } else {
            const amount = Number(coupon.discountValue) || 0;
            discountAmount = Math.min(amount, originalTotal);
            newTotal = Math.max(0, originalTotal - discountAmount);
        }
        
        const newUsedCount = (coupon.usedCount || 0) + 1;
        
        await couponDoc.ref.update({
            usedCount: newUsedCount,
            lastUsed: new Date().toISOString()
        });
        
        const discountText = coupon.discountType === 'percent' ? 
            `ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø®ØµÙ… ${coupon.discountValue}%` : 
            `ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø®ØµÙ… ${coupon.discountValue} Ø¬Ù†ÙŠÙ‡`;
        
        return {
            ok: true,
            discountAmount: discountAmount,
            text: discountText,
            couponKey: key,
            couponType: coupon.discountType,
            couponValue: coupon.discountValue,
            original: originalTotal,
            total: newTotal
        };
        
    } catch (error) {
        console.error('âŒ Error applying coupon:', error);
        return { ok: false, msg: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†' };
    }
}

document.getElementById('applyCouponBtn').addEventListener('click', async function(){
    try {
        const code = document.getElementById('couponCode').value;
        const safe = String(code).trim();
        
        if (!safe) {
            const msgEl = document.getElementById('couponMsg');
            msgEl.className = 'coupon-msg coupon-error';
            msgEl.textContent = 'âŒ Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…';
            return;
        }
        
        const applyBtn = document.getElementById('applyCouponBtn');
        const originalText = applyBtn.innerHTML;
        applyBtn.innerHTML = '<div class="loading"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...';
        applyBtn.disabled = true;
        
        const res = await applyCouponCode(safe);
        
        const msgEl = document.getElementById('couponMsg');
        if(res.ok){
            currentTotal = Number(res.total);
            appliedCouponKey = res.couponKey || null;
            appliedCouponData = res;
            
            msgEl.className = 'coupon-msg coupon-success';
            msgEl.textContent = 'ğŸ‰ ' + res.text + ' â€” ØªÙˆÙÙŠØ±: ' + res.discountAmount + ' Ø¬Ù†ÙŠÙ‡';
            totalPrice.innerHTML = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span style="text-decoration:line-through;color:#666">${res.original.toFixed(2)} EGP</span> ${res.total.toFixed(2)} EGP`;
        } else {
            currentTotal = originalTotal;
            appliedCouponKey = null;
            appliedCouponData = null;
            msgEl.className = 'coupon-msg coupon-error';
            msgEl.textContent = 'âŒ ' + res.msg;
            totalPrice.textContent = 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ' + currentTotal.toFixed(2) + ' EGP';
        }
    } catch(e){
        console.error('Coupon application error:', e);
        const msgEl = document.getElementById('couponMsg');
        msgEl.className = 'coupon-msg coupon-error';
        msgEl.textContent = 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹';
    } finally {
        const applyBtn = document.getElementById('applyCouponBtn');
        applyBtn.innerHTML = 'ØªØ·Ø¨ÙŠÙ‚';
        applyBtn.disabled = false;
    }
});

document.getElementById('confirmBtn').addEventListener('click', function(){
    try {
        const methodEl = document.querySelector("input[name='payment']:checked");
        if(!methodEl){ alert('âš ï¸ Ø§Ø®ØªØ± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹'); return; }
        const method = String(methodEl.value || '').trim();

        const original = Number(originalTotal || 0);
        const total = Number(currentTotal || original);
        const couponKey = appliedCouponKey || '';
        const discountAmount = appliedCouponData ? appliedCouponData.discountAmount : 0;
        const discountType = appliedCouponData ? appliedCouponData.couponType : '';
        const discountValue = appliedCouponData ? appliedCouponData.couponValue : '';

        let finalUrl = '';
        const cartParam = encodeURIComponent(JSON.stringify(cart));
        
        // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù€ URL Ù…Ø¹ ØªÙ…Ø±ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®ØµÙ…
        const qsParams = new URLSearchParams({
            cart: cartParam,
            original: original,
            total: total,
            coupon: couponKey
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®ØµÙ… ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø®ØµÙ…
        if (discountAmount > 0) {
            qsParams.append('discount', discountAmount);
            qsParams.append('discount_value', discountValue);
            qsParams.append('type', discountType);
        }
        
        const qs = qsParams.toString();

        if(method === 'Vodafone Cash') finalUrl = `final_vodafone.html?${qs}`;
        else if(method === 'Ø¬ÙˆØ§Ù‡Ø± Free Fire') finalUrl = `final_gems.html?${qs}`;
        else if(method === 'Binance') finalUrl = `final_binance.html?${qs}`;
        else { alert('âš ï¸ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©'); return; }

        if(total < 0) { alert('Ø®Ø·Ø£ Ø¨Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ'); return; }

        console.log('ğŸ”„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰:', finalUrl);
        console.log('ğŸ’° Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©:', {
            original: original,
            total: total,
            coupon: couponKey,
            discountAmount: discountAmount,
            discountType: discountType,
            discountValue: discountValue
        });

        window.location.href = finalUrl;
    } catch(e){
        console.error('Error in checkout:', e);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§');
    }
});

document.addEventListener('contextmenu', function(e){ e.preventDefault(); });
document.onkeydown = function(e){
    if(e.keyCode === 123 || (e.ctrlKey && e.key === 'u') || (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'C'))){
        e.preventDefault();
        return false;
    }
};

window.addEventListener('load', function() {
    console.log('ğŸš€ ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹ Ø¬Ø§Ù‡Ø²Ø©');
});
</script>

</body>
</html>
