<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vodafone Cash Payment â€” AIMHACK</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-red: #e60000;
      --primary-green: #00b800;
      --dark-bg: #000;
      --darker-bg: #121214;
      --card-bg: #151518;
      --input-bg: #1f1f23;
      --text-light: #ffffffbe;
      --border-radius: 14px;
      --transition: 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: var(--dark-bg);
      color: #fff;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      direction: rtl;
      line-height: 1.6;
    }
    
    .header {
      background: var(--dark-bg);
      padding: 16px 28px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--primary-red);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .logo {
      color: var(--primary-red);
      font-weight: 800;
      font-size: 22px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .logo i {
      font-size: 24px;
    }
    
    .container {
      max-width: 1100px;
      margin: 30px auto;
      padding: 0 20px;
      display: flex;
      gap: 20px;
    }
    
    .main {
      flex: 3;
    }
    
    .sidebar {
      flex: 1;
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      height: fit-content;
      position: sticky;
      top: 90px;
      box-shadow: 0 0 10px #000;
    }
    
    .box {
      background: var(--darker-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      box-shadow: 0 0 10px #000;
      transition: var(--transition);
    }
    
    .box:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(255, 0, 0, 0.1);
    }
    
    .product {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .product img {
      width: 90px;
      height: 70px;
      border-radius: 10px;
      object-fit: cover;
    }
    
    .product-info h2 {
      margin: 0;
      font-size: 16px;
    }
    
    .product-info p {
      margin: 4px 0;
      color: var(--text-light);
      font-size: 13px;
    }
    
    .price {
      color: #fff;
      font-weight: 700;
      font-size: 14px;
    }
    
    .price-old {
      text-decoration: line-through;
      color: #777;
      margin-right: 8px;
      font-size: 12px;
    }
    
    .pay-box {
      background: var(--input-bg);
      padding: 12px;
      border-radius: 10px;
      margin-top: 10px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .pay-box img {
      width: 45px;
      height: 45px;
      border-radius: 6px;
    }
    
    .copy-btn {
      margin-top: 10px;
      padding: 8px 12px;
      background: #333;
      border: none;
      border-radius: 6px;
      color: #b9b9b9ad;
      font-size: 13px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .copy-btn:hover {
      background: #555;
    }
    
    .form-group {
      margin: 12px 0;
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      color: #ccc;
      font-size: 14px;
    }
    
    input, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: var(--input-bg);
      color: #cacacad3;
      font-size: 14px;
      transition: var(--transition);
    }
    
    input:focus, textarea:focus {
      outline: 1px solid var(--primary-red);
    }
    
    textarea {
      resize: none;
      height: 70px;
    }
    
    input[type="file"] {
      background: none;
      padding: 5px;
      color: #ccc;
    }
    
    .btn {
      display: block;
      width: 100%;
      padding: 14px;
      background: var(--primary-red);
      border: none;
      border-radius: 10px;
      color: #f8f8f8be;
      font-weight: 700;
      cursor: pointer;
      font-size: 15px;
      margin-top: 15px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn:hover {
      background: var(--primary-green);
      color: #000;
    }
    
    .loading {
      display: none;
      text-align: center;
      margin-top: 15px;
      color: #aaa;
    }
    
    .summary h3 {
      margin-top: 0;
      color: #fff;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .summary p {
      margin: 6px 0;
      font-size: 14px;
    }
    
    .total {
      color: #fff;
      font-weight: 800;
      font-size: 16px;
    }
    
    .instructions {
      margin-top: 20px;
      padding: 15px;
      background: var(--input-bg);
      border-radius: 10px;
      font-size: 14px;
      line-height: 1.7;
      color: #ccc;
    }
    
    .instructions h4 {
      margin-top: 0;
      color: #ffcc00;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .instructions ul {
      padding-right: 18px;
    }
    
    .instructions li {
      margin-bottom: 8px;
    }
    
    .required-note {
      color: #ffdede;
      font-size: 13px;
      margin-top: 6px;
    }
    
    .small {
      font-size: 13px;
      color: #aaa;
    }
    
    .coupon-area {
      padding: 12px;
      background: #0f0f12;
      border-radius: 10px;
      margin-bottom: 12px;
    }
    
    .warn {
      background: #3b0a0a;
      padding: 10px;
      border-radius: 8px;
      color: #ffdede;
      margin-bottom: 12px;
    }
    
    .debug {
      font-size: 12px;
      color: #999;
      margin-top: 8px;
    }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      margin-bottom: 10px;
    }
    
    .status-online {
      background: rgba(0, 184, 0, 0.2);
      color: #00b800;
      border: 1px solid #00b800;
    }
    
    .status-offline {
      background: rgba(230, 0, 0, 0.2);
      color: #e60000;
      border: 1px solid #e60000;
    }
    
    .payment-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
      position: relative;
    }
    
    .step-indicator::before {
      content: '';
      position: absolute;
      top: 15px;
      right: 0;
      left: 0;
      height: 2px;
      background: #333;
      z-index: 1;
    }
    
    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
    }
    
    .step-number {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #333;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    .step.active .step-number {
      background: var(--primary-red);
    }
    
    .step.completed .step-number {
      background: var(--primary-green);
    }
    
    .step-text {
      font-size: 12px;
      color: #aaa;
      text-align: center;
    }
    
    .step.active .step-text {
      color: white;
    }
    
    .success-message {
      background: rgba(0, 184, 0, 0.1);
      border: 1px solid var(--primary-green);
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      text-align: center;
      display: none;
    }
    
    .success-message i {
      font-size: 40px;
      color: var(--primary-green);
      margin-bottom: 10px;
    }
    
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      
      .sidebar {
        position: static;
      }
      
      .product {
        flex-direction: column;
        text-align: center;
      }
      
      .step-indicator {
        flex-wrap: wrap;
        gap: 10px;
      }
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="logo">
      <i class="fas fa-shield-alt"></i>
      AIMHACK
    </div>
    <div>Ø§Ù„Ø¯ÙØ¹ â€” ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</div>
  </div>

  <div class="container">
    <div class="main" id="orderDetails"></div>
    <div class="sidebar summary" id="orderSummary"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAd5KNh5H6KaQ9nv8FP3keyFRh28zSwfLM",
      authDomain: "gama-xiter.firebaseapp.com",
      projectId: "gama-xiter",
      storageBucket: "gama-xiter.firebasestorage.app",
      messagingSenderId: "979348178199",
      appId: "1:979348178199:web:dd66b3d0d00b76fe61a352",
      measurementId: "G-4Q4P3GTJN5"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Payment System Configuration
    let vodafoneNumber = "........"; // Default number
    const adminPhone = "201064061942";
    const discordWebhook = "https://discord.com/api/webhooks/1431376358885298246/P-iOcVfwm21GZQkFtYUPCEhu1od4vHwh8rilHv_JoWk_y8lIgCBWE05QezeZPCcIur30";
    const REPORT_ENDPOINT = '';
    const MAX_IMAGE_MB = 8;

    // Helper functions
    function sanitizeInput(v, max=600) { 
      if(v==null) return ''; 
      let s=String(v).replace(/[<>`"]/g,'').trim(); 
      return s.length>max? s.slice(0,max): s; 
    }
    
    function isImageFile(file) { 
      if(!file) return false; 
      const allowed=['image/jpeg','image/png','image/jpg']; 
      return allowed.includes(file.type); 
    }
    
    function sendReport(obj) { 
      if(!REPORT_ENDPOINT) return; 
      try { 
        const body=JSON.stringify(Object.assign({when:new Date().toISOString(), url: location.href, ua:navigator.userAgent}, obj)); 
        if(navigator.sendBeacon) navigator.sendBeacon(REPORT_ENDPOINT, body); 
        else fetch(REPORT_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body,keepalive:true}).catch(()=>{}); 
      } catch(e){} 
    }

    // Firebase Listener for Vodafone Number Updates
    function setupPaymentListener() {
      console.log('ğŸ¯ Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙˆØ¯Ø§ÙÙˆÙ†...');
      
      db.collection('paymentNumbers').doc('current')
        .onSnapshot((doc) => {
          if (doc.exists) {
            const numbers = doc.data();
            console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø±Ù‚Ù… ÙÙˆØ¯Ø§ÙÙˆÙ†:', numbers);
            
            // Update Vodafone number
            vodafoneNumber = numbers.vodafone || "01064061942";
            
            // Update UI
            const vodaNumElement = document.getElementById('vodaNum');
            if (vodaNumElement) {
              vodaNumElement.textContent = vodafoneNumber;
            }
            
            // Update last update time
            const lastUpdateElement = document.getElementById('lastUpdate');
            if (lastUpdateElement) {
              lastUpdateElement.textContent = new Date().toLocaleTimeString();
            }
            
            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Vodafone Ø¥Ù„Ù‰:', vodafoneNumber);
          } else {
            console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase');
          }
        }, (error) => {
          console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙˆØ¯Ø§ÙÙˆÙ†:', error);
        });
    }

    // Read URL parameters
    const params = new URLSearchParams(window.location.search);
    let cart = [];
    
    if(params.has("cart")){
      try { 
        cart = JSON.parse(decodeURIComponent(params.get("cart"))); 
      } catch(e){ 
        sendReport({ reason:'cart_parse_error', detail:String(e).slice(0,200) }); 
        cart = []; 
      }
    }
    
    const originalParam = params.has('original') ? Number(params.get('original')) : null;
    const totalParam = params.has('total') ? Number(params.get('total')) : null;
    
    // COUPON: accept whatever case; try URL first, then sessionStorage fallback
    let couponParamRaw = params.has('coupon') ? String(params.get('coupon')).trim() : '';
    let couponParam = couponParamRaw ? couponParamRaw.toUpperCase() : '';
    
    try {
      if(!couponParam){
        const stored = sessionStorage.getItem('applied_coupon');
        if(stored){
          const obj = JSON.parse(stored);
          if(obj && obj.key) couponParam = String(obj.key).toUpperCase();
        }
      }
    } catch(e){ /* ignore */ }

    const discountParam = params.has('discount') ? Number(params.get('discount')) : null;
    const discountValueParam = params.has('discount_value') ? params.get('discount_value') : null;
    const discountTypeParam = params.has('type') ? String(params.get('type')) : null;
    const checksumParam = params.has('checksum') ? String(params.get('checksum')) : null;

    // Coupon mapping
    const couponMap = {
      "R2": { label: "RX30", type: "percent", value: 30 },
      "R1": { label: "RX1", type: "percent", value: 20 },
      "R3": { label: "ODAY100", type: "percent", value: 30 }
    };

    // Resolve totals & coupon
    let originalPrice = (originalParam !== null) ? originalParam : 0;
    let afterPrice = (totalParam !== null) ? totalParam : originalPrice;
    let couponUsed = null;
    let discountAmount = (discountParam !== null) ? discountParam : 0;
    let discountValue = discountValueParam || '';
    let discountType = discountTypeParam || '';

    // If checkout passed a coupon code recognized, use it to compute missing fields
    if(couponParam && couponMap[couponParam]) {
      couponUsed = couponMap[couponParam];
      if(!discountType || discountAmount === 0 || afterPrice === originalPrice){
        if(couponUsed.type === 'percent'){
          discountType = 'percent';
          discountValue = couponUsed.value;
          discountAmount = Math.round(originalPrice * couponUsed.value / 100);
          afterPrice = Math.max(0, originalPrice - discountAmount);
        } else {
          discountType = 'flat';
          discountValue = couponUsed.value;
          discountAmount = Math.min(couponUsed.value, originalPrice);
          afterPrice = Math.max(0, originalPrice - discountAmount);
        }
      }
    } else {
      // if coupon not recognized but discount/after provided, compute fallback percent
      if((discountAmount === 0 || discountAmount === null) && originalPrice && typeof afterPrice === 'number'){
        discountAmount = Math.round(originalPrice - afterPrice);
        if(originalPrice) discountValue = Math.round(discountAmount / originalPrice * 100);
        discountType = 'percent';
      }
      if(couponParam) couponUsed = { label: couponParam.toUpperCase(), type: discountType || 'unknown', value: discountValue || '' };
    }

    // Calculate originalPrice from cart if not provided
    if (!originalPrice && Array.isArray(cart) && cart.length > 0) {
      originalPrice = cart.reduce((total, item) => {
        const price = Number(item.price || 0);
        const qty = Number(item.qty || 1);
        return total + (price * qty);
      }, 0);
      
      // Recalculate afterPrice if needed
      if (afterPrice === 0 || afterPrice === originalPrice) {
        afterPrice = originalPrice - discountAmount;
      }
    }

    // rounding safety
    originalPrice = Number((originalPrice||0).toFixed(2));
    afterPrice = Number((afterPrice||0).toFixed(2));
    discountAmount = Number((discountAmount||0).toFixed(2));

    // Calculate price per item after discount
    function calculateItemPriceAfterDiscount(itemPrice, itemQty) {
      if (discountAmount === 0 || originalPrice === 0) {
        return itemPrice * itemQty;
      }
      
      // Calculate the percentage this item contributes to the total
      const itemTotal = itemPrice * itemQty;
      const itemPercentage = itemTotal / originalPrice;
      
      // Apply the same percentage of discount to this item
      const itemDiscount = discountAmount * itemPercentage;
      return itemTotal - itemDiscount;
    }

    // Render UI
    const container = document.getElementById("orderDetails");
    
    if(!Array.isArray(cart) || cart.length === 0){
      container.innerHTML = "<div class='box'><p>âš ï¸ No products in cart.</p></div>";
    } else {
      let html = '';
      
      // Step indicator
      html += `
        <div class="box">
          <div class="step-indicator">
            <div class="step active">
              <div class="step-number">1</div>
              <div class="step-text">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</div>
            </div>
            <div class="step">
              <div class="step-number">2</div>
              <div class="step-text">Ø£Ø±Ø³Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„</div>
            </div>
            <div class="step">
              <div class="step-number">3</div>
              <div class="step-text">Ø£Ø±ÙÙ‚ Ø§Ù„Ø³ÙƒØ±ÙŠÙ†</div>
            </div>
            <div class="step">
              <div class="step-number">4</div>
              <div class="step-text">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</div>
            </div>
          </div>
        </div>
      `;
      
      cart.forEach(item => {
        const img = sanitizeInput(item.img || 'placeholder.png');
        const title = sanitizeInput(item.name || item.title || 'Product');
        const price = Number(item.price || 0);
        const qty = Number(item.qty || 1);
        const itemTotal = price * qty;
        const itemAfterDiscount = calculateItemPriceAfterDiscount(price, qty);
        
        html += `
          <div class="box">
            <div class="product">
              <img src="${img}" alt="${title}">
              <div class="product-info">
                <h2>${title}</h2>
                ${discountAmount > 0 ? `
                  <p class="price">
                    <span class="price-old">${itemTotal.toFixed(2)} EGP</span>
                    ${itemAfterDiscount.toFixed(2)} EGP
                  </p>
                ` : `
                  <p class="price">${itemTotal.toFixed(2)} EGP</p>
                `}
                <p>Ø§Ù„ÙƒÙ…ÙŠØ©: ${qty}</p>
              </div>
            </div>
            <div class="payment-status">
              <div class="status-badge status-online">
                <i class="fas fa-wifi"></i>
                <span>Ù…ØªØµÙ„ - ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</span>
              </div>
              <div class="small">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="lastUpdate">${new Date().toLocaleTimeString()}</span></div>
            </div>
            <div class="pay-box">
              <i class="fas fa-mobile-alt" style="font-size: 24px; color: #e60000;"></i>
              <div>
                <strong>Ø­ÙˆÙ„ Ø¹Ù„ÙŠ Ø±Ù‚Ù… Ø¯Ù‡: <span id="vodaNum">${vodafoneNumber}</span></strong>
                <br>
                <button class="copy-btn" onclick="copyVoda()">
                  <i class="far fa-copy"></i> Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…
                </button>
              </div>
            </div>
          </div>
        `;
      });

      // coupon display
      const couponHtml = (couponUsed || couponParam) ? `
        <div class="form-group">
          <label>Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input type="text" id="couponShow" value="${sanitizeInput((couponUsed && couponUsed.label? couponUsed.label : couponParam) + (discountType === 'percent' && discountValue ? ' (' + discountValue + '%)' : (discountType === 'flat' && discountValue ? ' (' + discountValue + ' EGP)' : '')))}" readonly>
        </div>
      ` : '';

      html += `
        <div class="box">
          <div class="form-group">
            <label><i class="fas fa-user"></i> Ø§Ø³Ù…Ùƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input type="text" id="custName" autocomplete="name" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ">
          </div>
          <div class="form-group">
            <label><i class="fas fa-phone"></i> Ø±Ù‚Ù… ØªÙ„ÙÙˆÙ†Ùƒ (mobile)</label>
            <input type="text" id="custPhone" autocomplete="tel" placeholder="Ù…Ø«Ø§Ù„: 010xxxxxxxx">
          </div>
          <div class="form-group">
            <label><i class="fas fa-wallet"></i> Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø­ÙˆÙ„Øª Ù…Ù†Ùˆ</label>
            <input type="text" id="vodaWallet" placeholder="Ù…Ø«Ø§Ù„: 01XXXXXXXXX">
          </div>
          <div class="form-group">
            <label><i class="fab fa-discord"></i> ÙŠÙˆØ²Ø± Ø§Ù„Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯</label>
            <input type="text" id="custDiscord" placeholder="Ù…Ø«Ø§Ù„: user#1234">
          </div>
          <div class="form-group">
            <label><i class="fab fa-instagram"></i> ÙŠÙˆØ²Ø± Ø§Ù„Ø§Ù†Ø³ØªØ¬Ø±Ø§Ù…</label>
            <input type="text" id="custInstagram" placeholder="Ù…Ø«Ø§Ù„: @yourhandle">
          </div>
          ${couponHtml}
          <div class="form-group">
            <label><i class="fas fa-camera"></i> Ø³ÙƒØ±ÙŠÙ† Ø´ÙˆØª Ø§Ù„ØªØ­ÙˆÙŠÙ„ <span class="required-note">(Ù…Ø·Ù„ÙˆØ¨ - Ø£Ø±ÙÙ‚ ØµÙˆØ±Ø© ØªØ­ÙˆÙŠÙ„ ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´)</span></label>
            <input type="file" id="paymentImg" accept="image/png, image/jpeg">
          </div>
          <button class="btn" id="confirmBtn">
            <i class="fas fa-check-circle"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨
          </button>
          <div class="loading" id="loading">
            <i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...
          </div>
          <div class="success-message" id="successMessage">
            <i class="fas fa-check-circle"></i>
            <h3>ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!</h3>
            <p>Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ ÙˆØ§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹</p>
          </div>
          <div id="statusMsg" style="margin-top:10px;font-size:14px;"></div>
          <div class="debug" id="debugArea"></div>
        </div>
      `;

      container.innerHTML = html;
    }

    // Render Sidebar
    function renderSidebar(){
      const couponLabel = couponUsed ? (couponUsed.label || couponParam) : (couponParam || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø®ØµÙ…');
      const origStr = originalPrice ? `${originalPrice.toFixed(2)} EGP` : 'â€”';
      const afterStr = (typeof afterPrice === 'number') ? `${afterPrice.toFixed(2)} EGP` : 'â€”';
      const discountStr = discountType === 'percent' && discountValue ? `${discountValue}%` : (discountValue ? `${discountValue} EGP` : (discountAmount ? `${discountAmount} EGP` : 'â€”'));
      
      // Check if there's an actual discount
      const hasDiscount = discountAmount > 0 && originalPrice !== afterPrice;
      
      document.getElementById("orderSummary").innerHTML = `
        <h3><i class="fas fa-clipboard-list"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</h3>
        <p><i class="fas fa-shopping-bag"></i> Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: <strong>${Array.isArray(cart)?cart.length:0}</strong></p>
        <p><i class="fas fa-credit-card"></i> Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</p>
        
        ${hasDiscount ? `
          <p><i class="fas fa-receipt"></i> Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ: <span class="price-old">${origStr}</span></p>
          <p><i class="fas fa-tag"></i> Ø§Ù„Ø®ØµÙ…: <strong>${sanitizeInput(discountStr)}</strong></p>
          <p class="total"><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${afterStr}</p>
        ` : `
          <p class="total"><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${afterStr}</p>
        `}
        
        <div class="coupon-area">
          <div style="font-weight:800;margin-bottom:6px"><i class="fas fa-tag"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†</div>
          <div class="small">Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†: <strong>${sanitizeInput(couponLabel)}</strong></div>
          ${hasDiscount ? `
            <div style="margin-top:8px" class="small">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ: <span class="price-old">${origStr}</span></div>
            <div style="margin-top:8px" class="small">Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…: <strong>${afterStr}</strong></div>
            <div style="margin-top:8px" class="small">Ø§Ù„Ø®ØµÙ…: <strong>${sanitizeInput(discountStr)}</strong> (${discountAmount} Ø¬Ù†ÙŠÙ‡)</div>
          ` : `
            <div style="margin-top:8px" class="small">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø®ØµÙ… Ù…Ø·Ø¨Ù‚</div>
          `}
        </div>
        <div class="instructions">
          <h4><i class="fas fa-exclamation-triangle"></i> ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù‡Ø§Ù…Ø©:</h4>
          <ul>
            <li>ğŸ“‹ Ø§Ù†Ø³Ø® Ø±Ù‚Ù… ÙÙˆØ¯Ø§ÙÙˆÙ† ÙˆØ£Ø±Ø³Ù„ Ø§Ù„Ù…Ø¨Ù„Øº.</li>
            <li>ğŸ“¸ Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ (Ù…Ø·Ù„ÙˆØ¨).</li>
            <li>âœ… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨".</li>
            <li>â³ Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ.</li>
          </ul>
        </div>
      `;
    }
    renderSidebar();

    // Copy Vodafone number
    function copyVoda(){ 
      const num = document.getElementById("vodaNum").textContent.trim(); 
      navigator.clipboard.writeText(num).then(()=>{ 
        alert("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…: " + num); 
      }); 
    }

    // Confirm order handler
    async function confirmOrderHandler(){
      try {
        const statusEl = document.getElementById('statusMsg');
        const debugEl = document.getElementById('debugArea');
        const successMsg = document.getElementById('successMessage');
        statusEl.textContent = '';
        debugEl.textContent = '';
        successMsg.style.display = 'none';

        const name = sanitizeInput(document.getElementById("custName")?.value || '');
        const phone = sanitizeInput(document.getElementById("custPhone")?.value || '');
        const wallet = sanitizeInput(document.getElementById("vodaWallet")?.value || '');
        const discordUser = sanitizeInput(document.getElementById("custDiscord")?.value || '');
        const instagram = sanitizeInput(document.getElementById("custInstagram")?.value || '');
        const imgInput = document.getElementById("paymentImg");
        const screenshot = imgInput && imgInput.files && imgInput.files[0] ? imgInput.files[0] : null;

        // validations
        if(!name || !phone || !wallet || !discordUser){
          alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø§Ø³Ù…ØŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙØŒ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯.");
          return;
        }
        if(!screenshot){
          alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ (Ù…Ø·Ù„ÙˆØ¨).");
          return;
        }
        if(!isImageFile(screenshot)){ 
          alert("âŒ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… PNG Ø£Ùˆ JPG."); 
          return; 
        }
        if(screenshot.size > MAX_IMAGE_MB * 1024 * 1024){ 
          alert("âŒ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ " + MAX_IMAGE_MB + "MB."); 
          return; 
        }

        document.getElementById("loading").style.display = "block";
        const confirmBtnEl = document.getElementById("confirmBtn");
        if(confirmBtnEl) confirmBtnEl.disabled = true;

        // prepare products text
        let productsText = "";
        if(Array.isArray(cart) && cart.length){
          cart.forEach(p => { 
            const price = Number(p.price||0);
            const qty = Number(p.qty||1);
            const itemTotal = price * qty;
            const itemAfterDiscount = calculateItemPriceAfterDiscount(price, qty);
            
            productsText += `â€¢ ${sanitizeInput(p.name || p.title || 'product')} â€” ${itemAfterDiscount.toFixed(2)} EGP (x${qty})\n`; 
          });
        } else productsText = "No items";

        // coupon strings
        const couponLabel = couponUsed ? (couponUsed.label || couponParam) : (couponParam ? couponParam : 'No coupon');
        const discountStr = (discountType === 'percent' && discountValue) ? `${discountValue}% OFF` : (discountValue ? `${discountValue} EGP off` : (discountAmount ? `${discountAmount} EGP off` : 'â€”'));
        const originalStr = originalPrice ? `${originalPrice.toFixed(2)} EGP` : 'â€”';
        const afterStr = (typeof afterPrice === 'number') ? `${afterPrice.toFixed(2)} EGP` : 'â€”';
        const now = new Date().toLocaleString('ar-EG', { timeZone: 'Africa/Cairo' });

        // Prepare WhatsApp text
        const waPlain =
`ğŸ’³ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ â€” AIMHACK
ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}
ğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: ${phone}
ğŸ’³ Ù…Ø­ÙØ¸Ø© ÙÙˆØ¯Ø§ÙÙˆÙ†: ${wallet}
ğŸ® Ø§Ù„Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯: ${discordUser}
ğŸ“¸ Ø§Ù„Ø§Ù†Ø³ØªØ¬Ø±Ø§Ù…: ${instagram || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
ğŸŸï¸ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†: ${couponLabel} â€” ${discountType === 'percent' ? discountValue + '% OFF' : (discountAmount ? discountAmount + ' EGP off' : 'â€”')}
ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ: ${originalStr}
ğŸ”» Ø§Ù„Ø®ØµÙ…: ${discountAmount} EGP
ğŸ’µ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${afterStr}
ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:
${productsText}
ğŸ•’ Ø§Ù„ÙˆÙ‚Øª (Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©): ${now}
ğŸ“ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯.`;

        const waText = encodeURIComponent(waPlain);
        const waUrl = `https://wa.me/${adminPhone}?text=${waText}`;

        // Open WhatsApp window
        let waWindow = null;
        try {
          waWindow = window.open('about:blank', '_blank');
        } catch(e){
          waWindow = null;
        }

        // Send to Discord webhook
        let discordOk = false;
        let discordStatus = null;
        try {
          const filename = (screenshot && screenshot.name) ? screenshot.name.replace(/[^\w\.\-]/g,'_').slice(0,120) : 'transfer.jpg';
          const embed = {
            title: "ğŸ’³ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ â€” AIMHACK",
            color: 16711680,
            description: "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´",
            fields: [
              { name: "Ø§Ù„Ø§Ø³Ù…", value: name || "â€”", inline: false },
              { name: "Ø§Ù„Ù‡Ø§ØªÙ", value: phone || "â€”", inline: false },
              { name: "Ù…Ø­ÙØ¸Ø© ÙÙˆØ¯Ø§ÙÙˆÙ†", value: wallet || "â€”", inline: false },
              { name: "Ø§Ù„Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯", value: discordUser || "â€”", inline: false },
              { name: "Ø§Ù„Ø§Ù†Ø³ØªØ¬Ø±Ø§Ù…", value: instagram || "â€”", inline: false },
              { name: "Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†", value: `${couponLabel} â€” ${discountType === 'percent' ? discountValue + '% OFF' : (discountAmount ? discountAmount + ' EGP off' : 'â€”')}`, inline: false },
              { name: "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ", value: originalStr, inline: false },
              { name: "Ø§Ù„Ø®ØµÙ… (EGP)", value: `${discountAmount}`, inline: false },
              { name: "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ", value: afterStr, inline: false },
              { name: "Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", value: productsText || "â€”", inline: false },
              { name: "Ø§Ù„ÙˆÙ‚Øª (Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©)", value: now, inline: false },
              { name: "ØµÙˆØ±Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„", value: `Ù…Ø±ÙÙ‚: ${filename}`, inline: false }
            ],
            image: { url: `attachment://${filename}` }
          };

          const form = new FormData();
          form.append('payload_json', JSON.stringify({ username: 'AIMHACK BOT', embeds: [embed] }));
          form.append('file', screenshot, filename);

          const resp = await fetch(discordWebhook, { method: 'POST', body: form });
          discordStatus = resp.status;
          if(resp.ok) {
            discordOk = true;
            console.log('Discord webhook send OK', resp.status);
          } else {
            console.warn('Discord responded with', resp.status);
            sendReport({ reason:'discord_send_http_error', status: resp.status });
          }
        } catch(e){
          console.error('Discord webhook send failed', e);
          sendReport({ reason:'discord_send_error', detail: String(e).slice(0,200) });
        }

        // Open WhatsApp after Discord attempt
        if(waWindow){
          try {
            waWindow.location = waUrl;
          } catch(e){
            window.open(waUrl, '_blank');
          }
        } else {
          window.open(waUrl, '_blank');
        }

        // Success UI
        document.getElementById("loading").style.display = "none";
        successMsg.style.display = "block";
        if(confirmBtnEl) confirmBtnEl.disabled = false;

        // Debug info
        debugEl.textContent = `âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯ (${discordStatus})${discordOk?' âœ…':' âš ï¸'} â€” ØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨.`;

        // Report
        sendReport({ 
          event:'payment_submitted', 
          name_len:name.length, 
          phone_len:phone.length, 
          discord_len:discordUser.length, 
          instagram_len:instagram.length, 
          coupon:couponLabel, 
          products_count:Array.isArray(cart)?cart.length:0, 
          discord_ok:discordOk, 
          discord_status:discordStatus 
        });

      } catch(e){
        console.error('Order submission error', e);
        document.getElementById("loading").style.display = "none";
        document.getElementById("statusMsg").textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
        const confirmBtnEl = document.getElementById("confirmBtn");
        if(confirmBtnEl) confirmBtnEl.disabled = false;
        sendReport({ reason:'order_submit_error', detail: String(e).slice(0,200) });
      }
    }

    // Attach event listener
    document.addEventListener('DOMContentLoaded', function() {
      const confirmBtn = document.getElementById("confirmBtn");
      if(confirmBtn) {
        confirmBtn.addEventListener("click", confirmOrderHandler);
      }
      
      // Setup Firebase listener
      setupPaymentListener();
    });

  </script>
</body>
</html>